{% extends 'base.html' %}
{% block content %}

<h1>Build your own challenge!</h1>

<div id="step1">
    <form>
        <label>I spend too much money on
            <select name="original_items" onchange="showStep2()">
                    <option value="choose_an_item"></option>
                {% for original_items in challenges_list %}
                    <option value="{{ original_items }}">{{ original_items }}</option>
                {% endfor %}
            </select>
        </label>
    </form>
</div>

<div id="step2"><br>
    <form>
        <label>How many <span class="alt"></span> will you substitute for <span id="orig"></span>?<br>
            <input type="number" name="qty" id="qty" oninput="showStep3()"> <span class="alt"></span><br>
        </label>
    </form>
</div>

<div id="step3">
    <p>You will save $<span class="savings"></span>!</p>
    <h3>Here are the donation items that most closely match the amount you are saving:</h3>
    <div id="challenge"></div>
</div>

<script>
    $("#step2").css("visibility", "hidden");
    $("#step3").css("visibility", "hidden");

    function showStep2() {
        var original_items = encodeURIComponent($("#step1 option:selected").text());
        $.get(
            "/challenge_builder_step2/" + original_items,
            function (result) {
                $(".alt").text(result.alternative_items);
                $("#orig").text(result.original_items);
            }
        );
        $("#step2").css("visibility", "visible");
            };

    function showStep3() {
        $("#challenge").empty()
        var original_items = $("#step1 option:selected").text();
        var qty = $("#qty").val();
        $.get(
            "/challenge_builder_step2/" + original_items,
            function (result) {
                var donation_amt = (result.savings * qty);
                $(".savings").text(donation_amt);
                donation_amt = Math.round(donation_amt)
                // will have to figure out how to round
                $.get(
                    "/challenge_builder_step3/" + donation_amt,
                    function (result) {
                        console.log(result);
                        _.each(result.donation_item_price, function(donation_array) {
                            $("#challenge").append(
                                "<p>With $<span id='donation_price'>" + donation_array[1] + 
                                "</span> you can <span id='donation_item'>" + 
                                donation_array[0] + "</span>!</p>",

                                "<input type='button' data-donation_item='" +
                                 donation_array[0] + "' value='Accept' class='accept_button'>");
                        });
                        $(".accept_button").click(acceptChallenge)

                    });
            }
        );
        $("#step3").css("visibility", "visible");
    }
        

    function acceptChallenge(evt) {
        var data = $(evt.currentTarget).data();
        console.log(data.donation_item)
        var data_obj = { original_items: $("#orig").text(),
                        alternative_items: $(".alt").text(),
                        qty: $("#qty").val(),
                        donation_item: data.donation_item};
        var form = document.createElement('form');
        $(form).attr("method", "post").attr("action", "/profile");
        _.each(data_obj, function(value, key) {
            $("<input>").attr({
                name: key,
                value: value
            }).appendTo(form);
        });

        $(form).submit();
    }

</script>

{% endblock %}